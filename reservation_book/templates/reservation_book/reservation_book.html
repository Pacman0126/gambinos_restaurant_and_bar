{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12 mt-3 left">
            <h3>Reservation Book (Next 30 Days)</h3>

            <table class="table table-bordered table-hover text-center align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Date</th>
                        <th>17:00 - 18:00</th>
                        <th>18:00 - 19:00</th>
                        <th>19:00 - 20:00</th>
                        <th>20:00 - 21:00</th>
                        <th>21:00 - 22:00</th>
                    </tr>
                </thead>
                <tbody>
                {% for day in next_30_days %}
                <tr>
                    <td>{{ day.calendar_date }}</td>
                    {% for slot, slot_key in day.slots %}
                        {% with availability=availabilities|get_item:day.calendar_date %}
                        {% if availability %}
                            {% if slot_key == '17_18' %}
                                {% set left=availability.number_of_tables_available_17_18 %}
                            {% elif slot_key == '18_19' %}
                                {% set left=availability.number_of_tables_available_18_19 %}
                            {% elif slot_key == '19_20' %}
                                {% set left=availability.number_of_tables_available_19_20 %}
                            {% elif slot_key == '20_21' %}
                                {% set left=availability.number_of_tables_available_20_21 %}
                            {% elif slot_key == '21_22' %}
                                {% set left=availability.number_of_tables_available_21_22 %}
                            {% endif %}
                        {% else %}
                            {% set left=0 %}
                        {% endif %}

                        <td class="text-center {% if left <= 0 %}table-danger{% else %}table-success{% endif %}">
                            {% if left > 0 %}
                                {{ left }}
                            {% else %}
                                FULL
                            {% endif %}

                            {% if user.is_staff %}
                                <form method="post" action="{% url 'cancel_reservation' availability.pk %}" class="mt-2">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-danger">Cancel</button>
                                </form>
                            {% endif %}
                        </td>
                        {% endwith %}
                    {% endfor %}
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

<script>
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".cancel-reservation").forEach(btn => {
        btn.addEventListener("click", async () => {
            const reservationId = btn.dataset.reservationId;
            if (!confirm("Are you sure you want to cancel this reservation?")) return;

            try {
                const response = await fetch(`/cancel_reservation/${reservationId}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": getCookie("csrftoken"),
                        "X-Requested-With": "XMLHttpRequest"
                    }
                });
                const data = await response.json();

                if (data.success) {
                    alert("Reservation cancelled.");
                    window.location.reload(); // refresh table
                } else {
                    alert(data.error || "Failed to cancel reservation.");
                }
            } catch (err) {
                console.error(err);
                alert("Server error. Try again later.");
            }
        });
    });

    // CSRF helper function
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>