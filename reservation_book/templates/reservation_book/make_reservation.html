{%extends "base.html" %}

{% load static %}

{% block content %}


<!-- Reservation Form (wrapped around modal for submission) -->
<form method="post" id="reservationForm">
    {% csrf_token %}
    <input type="hidden" name="reservation_date" id="reservation_date">
    <input type="hidden" name="time_slot" id="time_slot">
    <input type="hidden" name="number_of_tables_required_by_patron" id="tables_needed" value="1">

    <!-- Customer Info Modal -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">Enter Reservation Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">First Name</label>
                    <input type="text" class="form-control" name="first_name" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Last Name</label>
                    <input type="text" class="form-control" name="last_name" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Country</label>
                    <select class="form-select" name="country_code" id="country_code">
                        <option value="GB" selected>United Kingdom</option>
                        <option value="DE">Germany</option>
                        <option value="FR">France</option>
                        <option value="US">United States</option>
                        <option value="IE">Ireland</option>
                        <!-- add more countries as needed -->
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Phone / Mobile <span class="text-danger">*</span></label>
                    <small class="form-text text-muted">Please provide at least one number</small>
                    <input type="text" class="form-control mb-2" name="phone" placeholder="Phone (Landline)">
                    <input type="text" class="form-control" name="mobile" placeholder="Mobile (for SMS)">
                    <div id="phoneError" class="text-danger mt-1" style="display: none;">
                        Phone required if no mobile provided (or vice versa).
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" name="email">
                    <small class="form-text text-muted text-danger">‚ö†Ô∏è Please check your spam folder for the confirmation email.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-success">Confirm Reservation</button>
            </div>
        </div>
    </div>
</div>
 
</form>

<!-- Availability Table -->
<h3 class="mb-3">Availability for the Next 30 Days</h3>
<table class="table table-bordered table-hover text-center align-middle">
    <thead class="table-dark">
        <tr>
            <th>Date</th>
            <th>17:00 - 18:00</th>
            <th>18:00 - 19:00</th>
            <th>19:00 - 20:00</th>
            <th>20:00 - 21:00</th>
            <th>21:00 - 22:00</th>
        </tr>
    </thead>
    <tbody>
    {% for day in next_30_days %}
    <tr>
        <td>{{ day.calendar_date }}</td>
        {% for slot, left in day.slots %}
            <td class="text-center {% if left <= 0 %}table-danger{% else %}table-success clickable{% endif %}"
                data-date="{{ day.calendar_date|date:'Y-m-d' }}"
                data-slot="{{ slot }}"
                data-left="{{ left }}">
                {% if left > 0 %}
                    {{ left }}
                {% else %}
                    FULL
                {% endif %}
            </td>
        {% endfor %}

    </tr>
    {% endfor %}
    </tbody>
</table>
{% endblock %}
{% block js %}
<!-- Script to handle cell clicks -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("reservationForm");
    const modalEl = document.getElementById("customerModal");
    const modal = new bootstrap.Modal(modalEl);
    const modalBody = modalEl.querySelector(".modal-body");
    const modalFooter = modalEl.querySelector(".modal-footer");
    const originalModalBody = modalBody.innerHTML;
    const originalModalFooter = modalFooter.innerHTML;
    let clickedCell = null;

    // Phone regex patterns per country
    const patterns = {
        "GB": /^(\+44\s?\d{9,10}|0\d{9,10})$/,                     // UK
        "DE": /^(?:\+49\s?[1-9]\d{6,12}|0[1-9]\d{6,12})$/,         // Germany
        "FR": /^(\+33\s?[1-9]\d{8}|0[1-9]\d{8})$/,                 // France
        "US": /^(\+1\s?\d{10}|[2-9]\d{9})$/,                       // US
        "IT": /^(\+39\s?\d{8,11}|0\d{8,11})$/,                     // Italy
        "IE": /^(\+353\s?\d{7,9}|0\d{7,9})$/,                      // Ireland
        "AT": /^(\+43\s?\d{7,12}|0\d{7,12})$/,                     // Austria
        "PL": /^(\+48\s?\d{9}|0\d{9})$/                            // Poland
    };

    // Handle availability cell clicks
    document.querySelectorAll("td[data-slot]").forEach(cell => {
        cell.addEventListener("click", () => {
            if (cell.dataset.left <= 0) return;
            clickedCell = cell;
            document.getElementById("reservation_date").value = cell.dataset.date;
            document.getElementById("time_slot").value = cell.dataset.slot;
            modalBody.innerHTML = originalModalBody;
            modalFooter.innerHTML = originalModalFooter;
            modal.show();
        });
    });

    // Handle form submit via AJAX
    form.addEventListener("submit", async function (e) {
        e.preventDefault();

        const phone = form.querySelector("input[name='phone']").value.trim();
        const mobile = form.querySelector("input[name='mobile']").value.trim();
        const country = form.querySelector("select[name='country_code']").value;
        const errorDiv = document.getElementById("phoneError");

        // Require at least one number
        if (!phone && !mobile) {
            errorDiv.textContent = "Please provide at least a phone or mobile number.";
            errorDiv.style.display = "block";
            return;
        }

        // Validate numbers if present
        let valid = true;
        if (phone && !patterns[country].test(phone)) {
            valid = false;
            errorDiv.textContent = "Invalid phone number for " + country;
        }
        if (mobile && !patterns[country].test(mobile)) {
            valid = false;
            errorDiv.textContent = "Invalid mobile number for " + country;
        }
        if (!valid) {
            errorDiv.style.display = "block";
            return;
        }
        errorDiv.style.display = "none";

        // Submit via fetch
        const formData = new FormData(form);
        try {
            const response = await fetch(form.action || window.location.href, {
                method: "POST",
                headers: { "X-Requested-With": "XMLHttpRequest" },
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                // Update clicked cell
                if (clickedCell) {
                    if (data.left > 0) {
                        clickedCell.textContent = data.left;
                        clickedCell.dataset.left = data.left;
                        clickedCell.classList.remove("table-danger");
                        clickedCell.classList.add("table-success");
                    } else {
                        clickedCell.textContent = "FULL";
                        clickedCell.dataset.left = 0;
                        clickedCell.classList.remove("table-success");
                        clickedCell.classList.add("table-danger");
                    }
                }

                // Show success message in modal with only a Close button
                modalBody.innerHTML = `
                    <div class="alert alert-success">
                        üéâ Your reservation is confirmed!<br>
                        Please also check your <strong>spam folder</strong> for the confirmation email.
                    </div>
                `;
                modalFooter.innerHTML = `
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                `;

                form.reset();
            } else {
                modalBody.insertAdjacentHTML("beforeend",
                    `<div class="alert alert-danger mt-3">${data.error || "Reservation failed."}</div>`
                );
            }
        } catch (err) {
            modalBody.insertAdjacentHTML("beforeend",
                `<div class="alert alert-danger mt-3">Server error. Please try again.</div>`
            );
            console.error(err);
        }
    });
});
</script>

{% endblock %}



