{% extends "base.html" %}
{% load static %}

{% block content %}

<!-- Reservation Modal -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <form id="reservationForm" method="post" action="{% url 'make_reservation' %}">
        {% csrf_token %}

        <div class="modal-header border-0">
          <h5 class="modal-title" id="customerModalLabel">
            {% if request.user.is_staff %}
              Phone Reservation – Caller Details & Confirmation
            {% else %}
              Confirm Your Reservation
            {% endif %}
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <!-- ALWAYS present: hidden fields the view expects -->
          <input type="hidden" name="reservation_date" id="reservation_date">
          <input type="hidden" name="time_slot" id="time_slot">
          <input type="hidden" name="selected_reservation_id" id="selected_reservation_id">

          <!-- Summary of what was clicked -->
          <div class="alert alert-secondary small" id="selectedSlotSummary">
            No time slot selected yet. Click an availability button in the grid.
          </div>

          {% if request.user.is_staff %}
          <!-- Staff: quick lookup row -->
           <div class="mb-3">
            <label for="customerLookup" class="form-label">
              Lookup existing customer (email or phone)
            </label>
            <div class="input-group">
              <input type="text"
                    id="customerLookup"
                    class="form-control"
                    placeholder="e.g. customer@example.com or 555-1234">
              <button type="button"
                      class="btn btn-outline-secondary"
                      id="btnCustomerLookup">
                Search
              </button>
            </div>

            <div class="mt-2" id="customerLookupControls" style="display:none;">
              <label for="customerLookupSelect" class="form-label mb-1">
                Multiple matches — pick one
              </label>
              <select id="customerLookupSelect" class="form-select">
                <!-- Populated dynamically -->
              </select>
              <div class="form-text">
                Selecting an entry will auto-fill the form. You can still override any field.
              </div>
            </div>

            <div class="form-text">
              Search by email, phone, first name + last name, or reservation ID.
            </div>
            <div class="form-text" id="customerLookupResult"></div>
          </div>

          {% endif %}

          <div class="row g-3">
            <!-- First name -->
            <div class="col-md-6">
              <label for="first_name" class="form-label">First Name</label>
              {% if request.user.is_authenticated and not request.user.is_staff %}
                <input
                  type="text"
                  class="form-control"
                  id="first_name"
                  name="first_name"
                  value="{{ request.user.first_name }}"
                  required
                >
              {% else %}
                <input
                  type="text"
                  class="form-control"
                  id="first_name"
                  name="first_name"
                  required
                >
              {% endif %}
            </div>

            <!-- Last name -->
            <div class="col-md-6">
              <label for="last_name" class="form-label">Last Name</label>
              {% if request.user.is_authenticated and not request.user.is_staff %}
                <input
                  type="text"
                  class="form-control"
                  id="last_name"
                  name="last_name"
                  value="{{ request.user.last_name }}"
                  required
                >
              {% else %}
                <input
                  type="text"
                  class="form-control"
                  id="last_name"
                  name="last_name"
                  required
                >
              {% endif %}
            </div>

            <!-- Email -->
            <div class="col-md-6">
              <label for="email" class="form-label">Email address</label>
              {% if request.user.is_authenticated and not request.user.is_staff %}
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  name="email"
                  value="{{ request.user.email }}"
                  required
                >
              {% else %}
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  name="email"
                  placeholder="customer@example.com"
                  required
                >
              {% endif %}
              <div class="form-text">
                Confirmation will be sent to this address.
              </div>
            </div>

            <!-- Phone -->
            <div class="col-md-6">
              <label for="phone" class="form-label">Phone (optional)</label>
              <input
                type="text"
                class="form-control"
                id="phone"
                name="phone"
                placeholder="+49 151 23456789"
              >
            </div>

            <!-- Mobile -->
            <div class="col-md-6">
              <label for="mobile" class="form-label">Mobile (optional)</label>
              <input
                type="text"
                class="form-control"
                id="mobile"
                name="mobile"
                placeholder="+49 151 23456789"
              >
            </div>

            <!-- Tables needed -->
            <div class="col-md-6">
              <label for="tables_needed" class="form-label">Tables needed</label>
              <input
                type="number"
                class="form-control"
                id="tables_needed"
                name="number_of_tables_required_by_patron"
                min="1"
                value="1"
                required
              >
              <div class="form-text" id="tablesRemainingHint">
                Select a time slot to see how many tables remain.
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer border-0 d-flex justify-content-between">
          {% if request.user.is_staff %}
            <a href="{% url 'staff_dashboard' %}" class="btn btn-outline-light">
              Back to Dashboard
            </a>
          {% endif %}
          <button type="submit" class="btn btn-danger">
            Confirm Reservation
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Availability table (shared for staff + online) -->
<h3 class="mb-3">Availability for the Next 30 Days</h3>
<div class="table-responsive">
  <table class="table table-bordered table-hover table-striped text-center align-middle bg-white">
    <thead class="table-dark">
      <tr>
        <th>Date</th>
        <th>17:00 - 18:00</th>
        <th>18:00 - 19:00</th>
        <th>19:00 - 20:00</th>
        <th>20:00 - 21:00</th>
        <th>21:00 - 22:00</th>
      </tr>
    </thead>
    <tbody>
      {% for ts in next_30_days %}
      <tr>
        <td class="fw-bold">{{ ts.calendar_date }}</td>
        {% for slot in ts.slots %}
        <td>
          <button
            type="button"
            class="btn btn-sm w-100
              {% if slot.remaining <= 0 %}
                btn-secondary disabled
              {% else %}
                btn-outline-primary
              {% endif %}"
            data-bs-toggle="modal"
            data-bs-target="#customerModal"
            data-date="{{ ts.calendar_date|date:'Y-m-d' }}"
            data-slot="{{ slot.key }}"
            data-left="{{ slot.remaining }}"
          >
            {{ slot.demand }}/{{ slot.available }}
          </button>
        </td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% endblock %}

{% block js %}
<script>
// --- CSRF helper (for future AJAX if needed) ---
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + "=")) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie("csrftoken");

// Simple debounce helper for live search
function debounce(fn, delay) {
  let timeoutId = null;
  return function (...args) {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => fn.apply(this, args), delay);
  };
}

// Fill the form fields from a result object (customer or reservation)
function fillCustomerFormFromResult(result) {
  const firstNameInput = document.getElementById("first_name");
  const lastNameInput  = document.getElementById("last_name");
  const emailInput     = document.getElementById("email");
  const phoneInput     = document.getElementById("phone");
  const mobileInput    = document.getElementById("mobile");

  if (firstNameInput) {
    firstNameInput.value = result.first_name || "";
  }
  if (lastNameInput) {
    lastNameInput.value = result.last_name || "";
  }
  if (emailInput) {
    emailInput.value = result.email || "";
  }
  if (phoneInput) {
    phoneInput.value = result.phone || "";
  }
  if (mobileInput) {
    mobileInput.value = result.mobile || "";
  }
}

// Apply a selected result: fill fields, and if it's a reservation, set IDs/slot/date
function applySelection(result) {
  fillCustomerFormFromResult(result);

  const selectedResId = document.getElementById("selected_reservation_id");
  const dateInput     = document.getElementById("reservation_date");
  const slotInput     = document.getElementById("time_slot");

  // If it's a reservation result, persist the reservation id so staff can update/cancel
  if (selectedResId) {
    if (result.type === "reservation" && result.reservation_id) {
      selectedResId.value = result.reservation_id;
    } else {
      selectedResId.value = "";
    }
  }

  // Optional convenience: pre-fill the selected date/slot for reservation hits
  if (result.type === "reservation") {
    if (dateInput && result.reservation_date) {
      dateInput.value = result.reservation_date;
    }
    if (slotInput && result.time_slot) {
      slotInput.value = result.time_slot;
    }
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const form    = document.getElementById("reservationForm");
  const modalEl = document.getElementById("customerModal");
  if (!form || !modalEl) return;

  const dateInput   = document.getElementById("reservation_date");
  const slotInput   = document.getElementById("time_slot");
  const tablesInput = document.getElementById("tables_needed");
  const summaryEl   = document.getElementById("selectedSlotSummary");
  const tablesHint  = document.getElementById("tablesRemainingHint");

  // --- AVAILABILITY GRID HANDLING ---
  document.querySelectorAll("button[data-slot][data-date]").forEach((btn) => {
    btn.addEventListener("click", () => {
      if (btn.classList.contains("disabled")) {
        return;
      }

      const dateVal = btn.getAttribute("data-date");
      const slotVal = btn.getAttribute("data-slot");
      const leftVal = btn.getAttribute("data-left");

      if (dateInput) dateInput.value = dateVal || "";
      if (slotInput) slotInput.value = slotVal || "";

      if (summaryEl) {
        const prettySlot = slotVal ? slotVal.replace("_", ":00-") : "";
        summaryEl.textContent =
          `Selected: ${dateVal} – ${prettySlot} (tables left: ${leftVal})`;
      }
      if (tablesHint) {
        tablesHint.textContent =
          `There are ${leftVal} tables left for this slot.`;
      }

      const remaining = parseInt(leftVal || "0", 10);
      if (tablesInput && remaining > 0) {
        tablesInput.max = remaining;
        if (parseInt(tablesInput.value || "0", 10) === 0) {
          tablesInput.value = 1;
        }
      }

      console.log("[DEBUG] Selected slot:", { dateVal, slotVal, leftVal });
    });
  });

  // --- FORM SUBMIT SAFETY CHECK ---
  form.addEventListener("submit", (e) => {
    const dateVal = dateInput ? dateInput.value : "";
    const slotVal = slotInput ? slotInput.value : "";

    if (!dateVal || !slotVal) {
      e.preventDefault();
      alert("Please click a date/time cell in the availability grid before confirming.");
      console.warn("[DEBUG] Submit blocked: missing date or slot", { dateVal, slotVal });
      return;
    }

    console.log("[DEBUG] Submitting reservation with:", {
      date: dateVal,
      slot: slotVal,
      tables: tablesInput ? tablesInput.value : null
    });
  });

  // Reset summary & hidden fields when modal closes
  modalEl.addEventListener("hidden.bs.modal", () => {
    if (dateInput) dateInput.value = "";
    if (slotInput) slotInput.value = "";
    if (summaryEl) {
      summaryEl.textContent = "No time slot selected yet. Click an availability button in the grid.";
    }
    if (tablesHint) {
      tablesHint.textContent = "Select a time slot to see how many tables remain.";
    }
    const selectedResId = document.getElementById("selected_reservation_id");
    if (selectedResId) selectedResId.value = "";
  });

  // --- STAFF LOOKUP (LIVE SEARCH + EXPANDED DROPDOWN WITH RESERVATION DETAILS) ---
  const lookupInput    = document.getElementById("customerLookup");
  const lookupResult   = document.getElementById("customerLookupResult");
  const lookupControls = document.getElementById("customerLookupControls");
  const lookupSelect   = document.getElementById("customerLookupSelect");
  const selectedResId  = document.getElementById("selected_reservation_id");

  let lastResults = [];

  function renderLookupResults(results) {
    lastResults = results || [];

    if (!lookupControls || !lookupSelect || !lookupResult) return;

    if (!lastResults.length) {
      lookupControls.style.display = "none";
      lookupSelect.innerHTML = "";
      lookupResult.textContent = "No matching customer or reservation found.";
      if (selectedResId) selectedResId.value = "";
      return;
    }

    // Exactly one result -> auto-fill and hide dropdown
    if (lastResults.length === 1) {
      const r = lastResults[0];
      applySelection(r);
      lookupControls.style.display = "none";
      lookupSelect.innerHTML = "";
      const fullName = `${r.first_name || ""} ${r.last_name || ""}`.trim() || "(no name)";
      lookupResult.textContent = `Auto-filled: ${fullName}`;
      return;
    }

    // Multiple results -> expanded dropdown
    lookupSelect.innerHTML = "";
    lastResults.forEach((r, index) => {
      const opt = document.createElement("option");
      opt.value = String(index);

      const fullName = `${r.first_name || ""} ${r.last_name || ""}`.trim() || "(no name)";
      const parts = [];

      // Type marker
      parts.push(r.type === "reservation" ? "RES" : "CUST");

      // Identity
      parts.push(fullName);
      if (r.email) parts.push(`email: ${r.email}`);
      if (r.phone) parts.push(`phone: ${r.phone}`);
      if (r.mobile) parts.push(`mobile: ${r.mobile}`);

      // Reservation-specific details
      if (r.type === "reservation") {
        const dateStr = r.reservation_date || "";
        const timeStr = r.pretty_slot || r.time_slot || "";
        const idStr   = r.reservation_id ? `#${r.reservation_id}` : "";
        const status  = (r.reservation_status === false) ? "(cancelled)" : "";
        parts.push(`${idStr} ${dateStr} ${timeStr}`.trim());
        if (status) parts.push(status);
      }

      opt.textContent = parts.join(" | ");
      lookupSelect.appendChild(opt);
    });

    lookupSelect.multiple = true;
    lookupSelect.size = Math.min(lastResults.length, 8);
    lookupControls.style.display = "block";

    lookupResult.textContent =
      `${lastResults.length} result(s). Keep typing to narrow it, then click one to auto-fill.`;
  }

  function performLookup(query) {
    if (!query) {
      if (lookupControls) lookupControls.style.display = "none";
      if (lookupSelect) lookupSelect.innerHTML = "";
      if (lookupResult) lookupResult.textContent = "";
      if (selectedResId) selectedResId.value = "";
      return;
    }

    if (lookupResult) {
      lookupResult.textContent = "Searching…";
    }

    fetch(`/ajax/lookup-customer/?q=${encodeURIComponent(query)}`, {
      method: "GET",
      headers: {
        "X-Requested-With": "XMLHttpRequest"
      }
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error("Network response was not ok");
        }
        return response.json();
      })
      .then((data) => {
        console.log("[DEBUG] lookup data:", data);
        const results = data.results || [];
        renderLookupResults(results);
      })
      .catch((err) => {
        console.error("[ERROR] lookup failed:", err);
        if (lookupResult) {
          lookupResult.textContent = "Error while searching for customer.";
        }
        if (lookupControls) lookupControls.style.display = "none";
        if (lookupSelect) lookupSelect.innerHTML = "";
        if (selectedResId) selectedResId.value = "";
      });
  }

  const debouncedLookup = debounce(() => {
    if (!lookupInput) return;
    const q = lookupInput.value.trim();
    if (q.length < 2) {
      if (lookupControls) lookupControls.style.display = "none";
      if (lookupSelect) lookupSelect.innerHTML = "";
      if (lookupResult) {
        lookupResult.textContent = "Type at least 2 characters to search.";
      }
      if (selectedResId) selectedResId.value = "";
      return;
    }
    performLookup(q);
  }, 250);

  if (lookupInput) {
    // Live search: every keystroke is effectively a "Search" click
    lookupInput.addEventListener("input", debouncedLookup);
  }

  if (lookupSelect) {
    lookupSelect.addEventListener("change", () => {
      const idx = parseInt(lookupSelect.value, 10);
      if (Number.isNaN(idx) || !lastResults[idx]) return;
      applySelection(lastResults[idx]);
    });
  }
});
</script>


{% endblock %}







