{% extends "base.html" %}
{% load static %}

{% block content %}

<!-- Reservation Modal -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <form id="reservationForm" method="post" action="{% url 'make_reservation' %}">
        {% csrf_token %}

        <div class="modal-header border-0">
          <h5 class="modal-title" id="customerModalLabel">
            {% if request.user.is_staff %}
              Phone Reservation – Caller Details & Confirmation
            {% else %}
              Confirm Your Reservation
            {% endif %}
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <!-- ALWAYS present: hidden fields the view expects -->
          <input type="hidden" name="reservation_date" id="reservation_date">
          <input type="hidden" name="time_slot" id="time_slot">

          <!-- Summary of what was clicked -->
          <div class="alert alert-secondary small" id="selectedSlotSummary">
            No time slot selected yet. Click an availability button in the grid.
          </div>

          {% if request.user.is_staff %}
          <!-- Staff: quick lookup row -->
          <div class="mb-3">
            <label for="customerLookup" class="form-label">
              Lookup existing customer (email or phone)
            </label>
            <div class="input-group">
              <input type="text"
                     id="customerLookup"
                     class="form-control"
                     placeholder="e.g. customer@example.com or 555-1234">
              <button type="button"
                      class="btn btn-outline-secondary"
                      id="btnCustomerLookup">
                Search
              </button>
            </div>
            <div class="form-text">
              If a match is found, the form below will be auto-filled. You can still change any field before confirming.
            </div>
            <div class="form-text" id="customerLookupResult"></div>
          </div>
          {% endif %}

          <div class="row g-3">
            <!-- First name -->
            <div class="col-md-6">
              <label for="first_name" class="form-label">First Name</label>
              {% if request.user.is_authenticated and not request.user.is_staff %}
                <input
                  type="text"
                  class="form-control"
                  id="first_name"
                  name="first_name"
                  value="{{ request.user.first_name }}"
                  required
                >
              {% else %}
                <input
                  type="text"
                  class="form-control"
                  id="first_name"
                  name="first_name"
                  required
                >
              {% endif %}
            </div>

            <!-- Last name -->
            <div class="col-md-6">
              <label for="last_name" class="form-label">Last Name</label>
              {% if request.user.is_authenticated and not request.user.is_staff %}
                <input
                  type="text"
                  class="form-control"
                  id="last_name"
                  name="last_name"
                  value="{{ request.user.last_name }}"
                  required
                >
              {% else %}
                <input
                  type="text"
                  class="form-control"
                  id="last_name"
                  name="last_name"
                  required
                >
              {% endif %}
            </div>

            <!-- Email -->
            <div class="col-md-6">
              <label for="email" class="form-label">Email address</label>
              {% if request.user.is_authenticated and not request.user.is_staff %}
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  name="email"
                  value="{{ request.user.email }}"
                  required
                >
              {% else %}
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  name="email"
                  placeholder="customer@example.com"
                  required
                >
              {% endif %}
              <div class="form-text">
                Confirmation will be sent to this address.
              </div>
            </div>

            <!-- Phone -->
            <div class="col-md-6">
              <label for="phone" class="form-label">Phone (optional)</label>
              <input
                type="text"
                class="form-control"
                id="phone"
                name="phone"
                placeholder="+49 151 23456789"
              >
            </div>

            <!-- Mobile -->
            <div class="col-md-6">
              <label for="mobile" class="form-label">Mobile (optional)</label>
              <input
                type="text"
                class="form-control"
                id="mobile"
                name="mobile"
                placeholder="+49 151 23456789"
              >
            </div>

            <!-- Tables needed -->
            <div class="col-md-6">
              <label for="tables_needed" class="form-label">Tables needed</label>
              <input
                type="number"
                class="form-control"
                id="tables_needed"
                name="number_of_tables_required_by_patron"
                min="1"
                value="1"
                required
              >
              <div class="form-text" id="tablesRemainingHint">
                Select a time slot to see how many tables remain.
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer border-0 d-flex justify-content-between">
          {% if request.user.is_staff %}
            <a href="{% url 'staff_dashboard' %}" class="btn btn-outline-light">
              Back to Dashboard
            </a>
          {% endif %}
          <button type="submit" class="btn btn-danger">
            Confirm Reservation
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Availability table (shared for staff + online) -->
<h3 class="mb-3">Availability for the Next 30 Days</h3>
<div class="table-responsive">
  <table class="table table-bordered table-hover table-striped text-center align-middle bg-white">
    <thead class="table-dark">
      <tr>
        <th>Date</th>
        <th>17:00 - 18:00</th>
        <th>18:00 - 19:00</th>
        <th>19:00 - 20:00</th>
        <th>20:00 - 21:00</th>
        <th>21:00 - 22:00</th>
      </tr>
    </thead>
    <tbody>
      {% for ts in next_30_days %}
      <tr>
        <td class="fw-bold">{{ ts.calendar_date }}</td>
        {% for slot in ts.slots %}
        <td>
          <button
            type="button"
            class="btn btn-sm w-100
              {% if slot.remaining <= 0 %}
                btn-secondary disabled
              {% else %}
                btn-outline-primary
              {% endif %}"
            data-bs-toggle="modal"
            data-bs-target="#customerModal"
            data-date="{{ ts.calendar_date|date:'Y-m-d' }}"
            data-slot="{{ slot.key }}"
            data-left="{{ slot.remaining }}"
          >
            {{ slot.demand }}/{{ slot.available }}
          </button>
        </td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% endblock %}

{% block js %}
<script>
// --- CSRF helper (for future AJAX if needed) ---
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + "=")) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie("csrftoken");

document.addEventListener("DOMContentLoaded", () => {
  const form        = document.getElementById("reservationForm");
  const modalEl     = document.getElementById("customerModal");
  const dateInput   = document.getElementById("reservation_date");
  const slotInput   = document.getElementById("time_slot");
  const tablesInput = document.getElementById("tables_needed");
  const summaryEl   = document.getElementById("selectedSlotSummary");
  const tablesHint  = document.getElementById("tablesRemainingHint");

  // -----------------------------
  // 1) Grid click: store date/slot
  // -----------------------------
  document.querySelectorAll("button[data-slot][data-date]").forEach((btn) => {
    btn.addEventListener("click", () => {
      if (btn.classList.contains("disabled")) {
        return;
      }

      const dateVal = btn.getAttribute("data-date");
      const slotVal = btn.getAttribute("data-slot");
      const leftVal = btn.getAttribute("data-left");

      if (dateInput) dateInput.value = dateVal || "";
      if (slotInput) slotInput.value = slotVal || "";

      if (summaryEl) {
        const prettySlot = slotVal
          ? slotVal.replace("_", ":00-").replace("_", ":00-")
          : "";
        summaryEl.textContent =
          `Selected: ${dateVal} – ${prettySlot} (tables left: ${leftVal})`;
      }
      if (tablesHint) {
        tablesHint.textContent =
          `There are ${leftVal} tables left for this slot.`;
      }

      const remaining = parseInt(leftVal || "0", 10);
      if (tablesInput && remaining > 0) {
        tablesInput.max = remaining;
        if (parseInt(tablesInput.value || "0", 10) === 0) {
          tablesInput.value = 1;
        }
      }

      console.log("[DEBUG] Selected slot:", { dateVal, slotVal, leftVal });
    });
  });

  // -----------------------------
  // 2) Form submit guard
  // -----------------------------
  if (form) {
    form.addEventListener("submit", (e) => {
      const dateVal = dateInput ? dateInput.value : "";
      const slotVal = slotInput ? slotInput.value : "";

      if (!dateVal || !slotVal) {
        e.preventDefault();
        alert("Please click a date/time cell in the availability grid before confirming.");
        console.warn("[DEBUG] Submit blocked: missing date or slot", { dateVal, slotVal });
        return;
      }

      console.log("[DEBUG] Submitting reservation with:", {
        date: dateVal,
        slot: slotVal,
        tables: tablesInput ? tablesInput.value : null
      });
    });
  }

  // -----------------------------
  // 3) Reset modal on close
  // -----------------------------
  if (modalEl) {
    modalEl.addEventListener("hidden.bs.modal", () => {
      if (dateInput) dateInput.value = "";
      if (slotInput) slotInput.value = "";
      if (summaryEl) {
        summaryEl.textContent =
          "No time slot selected yet. Click an availability button in the grid.";
      }
      if (tablesHint) {
        tablesHint.textContent =
          "Select a time slot to see how many tables remain.";
      }
    });
  }

  // -----------------------------
  // 4) Staff customer lookup
  // -----------------------------
  const lookupInput   = document.getElementById("customerLookup");
  const lookupBtn     = document.getElementById("btnCustomerLookup");
  const lookupResult  = document.getElementById("customerLookupResult");

  const firstNameInput = document.getElementById("first_name");
  const lastNameInput  = document.getElementById("last_name");
  const emailInput     = document.getElementById("email");
  const phoneInput     = document.getElementById("phone");
  const mobileInput    = document.getElementById("mobile");

  function applyCustomerToForm(c) {
    if (!c) return;

    if (firstNameInput && c.first_name) {
      firstNameInput.value = c.first_name;
    }
    if (lastNameInput && c.last_name) {
      lastNameInput.value = c.last_name;
    }

    if (emailInput && c.email) {
      emailInput.value = c.email;
    }
    if (phoneInput && c.phone) {
      phoneInput.value = c.phone;
    }
    if (mobileInput && c.mobile) {
      mobileInput.value = c.mobile;
    }
  }

  async function doCustomerLookup() {
    if (!lookupInput || !lookupResult) return;

    const q = lookupInput.value.trim();
    if (!q) {
      lookupResult.textContent =
        "Enter email, name, phone, or reservation ID.";
      return;
    }

    lookupResult.textContent = "Searching...";
    console.log("[DEBUG] Calling /ajax/lookup-customer/ with:", q);

    try {
      const resp = await fetch(
        `/ajax/lookup-customer/?q=${encodeURIComponent(q)}`,
        {
          method: "GET",
          headers: {
            "X-Requested-With": "XMLHttpRequest"
          }
        }
      );

      if (!resp.ok) {
        lookupResult.textContent = `Lookup failed (${resp.status}).`;
        console.error("[DEBUG] Customer lookup HTTP error", resp.status);
        return;
      }

      const data = await resp.json();
      console.log("[DEBUG] Lookup JSON:", data);

      if (!data || !data.success || !data.found || !data.customer) {
        lookupResult.textContent = "No matching customer found.";
        return;
      }

      applyCustomerToForm(data.customer);

      const labelName = `${data.customer.first_name || ""} ${data.customer.last_name || ""}`.trim();
      const labelEmail = data.customer.email || "";
      lookupResult.textContent =
        `Loaded customer: ${labelName || "(no name)"}${labelEmail ? " – " + labelEmail : ""}`;

    } catch (err) {
      console.error("[DEBUG] Error during customer lookup:", err);
      lookupResult.textContent =
        "Error performing lookup. See console.";
    }
  }

  if (lookupBtn && lookupInput) {
    lookupBtn.addEventListener("click", (evt) => {
      evt.preventDefault();
      doCustomerLookup();
    });

    // Allow pressing Enter in the search box
    lookupInput.addEventListener("keydown", (evt) => {
      if (evt.key === "Enter") {
        evt.preventDefault();
        doCustomerLookup();
      }
    });
  }
});
</script>
{% endblock %}




