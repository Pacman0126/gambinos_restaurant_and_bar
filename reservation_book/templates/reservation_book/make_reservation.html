{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Make a Reservation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="p-4">

<h1 class="mb-4">Reserve a Table</h1>

{% if messages %}
<div class="alert-messages">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
</div>
{% endif %}

<!-- Reservation Form (wrapped around modal for submission) -->
<form method="post" id="reservationForm">
    {% csrf_token %}
    <input type="hidden" name="reservation_date" id="reservation_date">
    <input type="hidden" name="time_slot" id="time_slot">
    <input type="hidden" name="number_of_tables_required_by_patron" id="tables_needed" value="1">

    <!-- Customer Info Modal -->
    <div class="modal fade" id="customerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">Enter Reservation Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">First Name</label>
                        <input type="text" class="form-control" name="first_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Last Name</label>
                        <input type="text" class="form-control" name="last_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone (Landline)</label>
                        <input type="text" class="form-control" name="phone">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mobile (SMS)</label>
                        <input type="text" class="form-control" name="mobile" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Confirm Reservation</button>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Availability Table -->
<h3 class="mb-3">Availability for the Next 30 Days</h3>
<table class="table table-bordered table-hover text-center align-middle">
    <thead class="table-dark">
        <tr>
            <th>Date</th>
            <th>17:00 - 18:00</th>
            <th>18:00 - 19:00</th>
            <th>19:00 - 20:00</th>
            <th>20:00 - 21:00</th>
            <th>21:00 - 22:00</th>
        </tr>
    </thead>
    <tbody>
    {% for day in next_30_days %}
    <tr>
        <td>{{ day.calendar_date }}</td>
        {% for slot, left in day.slots %}
            <td class="text-center {% if left <= 0 %}table-danger{% else %}table-success clickable{% endif %}"
                data-date="{{ day.calendar_date }}"
                data-slot="{{ slot }}"
                data-left="{{ left }}">
                {% if left > 0 %}
                    {{ left }}
                {% else %}
                    FULL
                {% endif %}
            </td>
        {% endfor %}

    </tr>
    {% endfor %}
    </tbody>
</table>

<!-- Script to handle cell clicks -->
<script>
document.querySelectorAll("td[data-slot]").forEach(cell => {
    cell.addEventListener("click", () => {
        if (cell.dataset.left <= 0) return; // skip FULL cells
        document.getElementById("reservation_date").value = cell.dataset.date;
        document.getElementById("time_slot").value = cell.dataset.slot;
        let modal = new bootstrap.Modal(document.getElementById("customerModal"));
        modal.show();
    });
});
</script>

</body>
</html>
