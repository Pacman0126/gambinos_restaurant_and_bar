{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-4">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">Staff Reservations</h2>
  </div>

  <div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th style="width: 70px;">ID</th>
          <th style="width: 140px;">Date</th>
          <th style="width: 170px;">Time Slot</th>
          <th style="width: 90px;">Tables</th>
          <th>Customer</th>
          <th style="width: 140px;">Status</th>
          <th style="width: 320px;">Actions</th>
        </tr>
      </thead>

      <tbody>
        {% for r in reservations %}
          <tr>
            <td>{{ r.id }}</td>

            <td>{{ r.reservation_date|date:"M d, Y" }}</td>

            <td>
              {{ r.time_range_pretty }}
              {% if r.duration_hours|default:1 > 1 %}
                <div class="small text-muted">{{ r.duration_hours }} hour block</div>
              {% endif %}
            </td>

            <td>{{ r.number_of_tables_required_by_patron }}</td>

            <td>
              <div class="fw-semibold">
                {{ r.customer.first_name|default:"" }} {{ r.customer.last_name|default:"" }}
              </div>
              {% if r.customer.email %}<div class="small text-muted">{{ r.customer.email }}</div>{% endif %}
              {% if r.customer.phone %}<div class="small text-muted">{{ r.customer.phone }}</div>{% endif %}
              {% if r.customer and r.customer.barred %}
                <span class="badge bg-danger ms-1">Barred</span>
              {% endif %}

              {% if r.is_phone_reservation %}
                <span class="badge bg-info text-dark mt-1">Phone-in</span>
              {% else %}
                <span class="badge bg-success mt-1">Online</span>
              {% endif %}
            </td>

            {# -------------------- #}
            {# STATUS COLUMN = badge only #}
            {# -------------------- #}
            <td>
              {% if r.status == 'no_show' %}
                <span class="badge bg-danger">No Show</span>

              {% elif r.status == 'cancelled' %}
                <span class="badge bg-secondary">Cancelled</span>

              {% elif r.status == 'completed' %}
                <span class="badge bg-primary">Completed</span>

              {% elif r.status == 'active' %}
                {% if r.reservation_date < today %}
                  <span class="badge bg-warning text-dark">Past (awaiting sweep)</span>
                {% else %}
                  <span class="badge bg-success">Active</span>
                {% endif %}

              {% else %}
                {# Fallback for legacy-only rows #}
                {% if r.reservation_status %}
                  {% if r.reservation_date < today %}
                    <span class="badge bg-warning text-dark">Past (legacy)</span>
                  {% else %}
                    <span class="badge bg-success">Active (legacy)</span>
                  {% endif %}
                {% else %}
                  <span class="badge bg-secondary">Inactive</span>
                {% endif %}
              {% endif %}
            </td>

            {# -------------------- #}
            {# ACTIONS COLUMN (H2-1) #}
            {# -------------------- #}
            <td class="text-nowrap">

              {# ---------- EDIT ---------- #}
              {% if r.reservation_date and r.reservation_date >= today and r.status == 'active' %}
                <a class="btn btn-sm btn-outline-warning"
                  href="{% url 'update_reservation' r.id %}?next={% url 'staff_reservations' %}">
                  Edit
                </a>
              {% else %}
                <button type="button" class="btn btn-sm btn-outline-warning" disabled
                        title="Edit is only available for active reservations on today/future dates">
                  Edit
                </button>
              {% endif %}

              {# ---------- CANCEL ---------- #}
              {% if r.reservation_date and r.reservation_date >= today and r.status == 'active' %}
                <form method="post" action="{% url 'cancel_reservation' r.id %}" class="d-inline">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-outline-danger"
                          onclick="return confirm('Cancel this reservation?');">
                    Cancel
                  </button>
                </form>
              {% else %}
                <button type="button" class="btn btn-sm btn-outline-danger" disabled
                        title="Cancel is only available for active reservations on today/future dates">
                  Cancel
                </button>
              {% endif %}

              {# ---------- COMPLETE (today only) ---------- #}
              {% if r.status == 'active' and r.reservation_date and r.reservation_date == today %}
                <form method="post" action="{% url 'mark_reservation_completed' r.id %}" class="d-inline">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-outline-success"
                          onclick="return confirm('Mark this reservation as completed?');">
                    Complete
                  </button>
                </form>
              {% elif r.status == 'active' and r.reservation_date and r.reservation_date > today %}
                <button type="button" class="btn btn-sm btn-outline-success" disabled
                        title="Complete can only be set on the reservation date">
                  Complete
                </button>
              {% endif %}

              {# ---------- NO SHOW (past only) ---------- #}
              {% if r.status == 'active' and r.reservation_date and r.reservation_date < today %}
                <form method="post" action="{% url 'mark_no_show' r.id %}" class="d-inline">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-outline-dark"
                          onclick="return confirm('Mark this reservation as a NO SHOW?');">
                    No Show
                  </button>
                </form>
              {% endif %}

            </td>            
          </tr>
        {% empty %}
          <tr>
            <td colspan="7" class="text-center text-muted py-4">
              No reservations found.
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>
{% endblock %}