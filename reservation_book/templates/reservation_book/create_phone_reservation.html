{% extends "base.html" %}
{% load static %}
{% load slot_filters %}

{% block content %}
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Phone Reservation</h2>
    <a href="{% url 'staff_dashboard' %}" class="btn btn-outline-light">Back to Dashboard</a>
  </div>

  <p class="text-muted">
    Click an availability cell to select a date/time slot, then complete caller details and confirm.
  </p>

  <div class="card bg-dark text-light shadow-sm mb-4">
    <div class="card-header">
      <strong>Next 30 days availability</strong>
    </div>

    <div class="card-body p-2">
      <div class="table-responsive">
        <table class="table table-dark table-bordered align-middle mb-0">
          <thead>
            <tr>
              <th style="min-width: 180px;">Date</th>
              {% for slot in slot_labels.items %}
                <th class="text-center">{{ slot.1 }}</th>
              {% endfor %}
            </tr>
          </thead>

          <tbody>
            {% for day_data in next_30_days %}

              {% with d=day_data.date d_iso=day_data.date|date:"Y-m-d" %}
                <tr>
                  <td class="align-middle">
                    {{ d|date:"D, M j, Y" }}
                  </td>

                  {% for slot in day_data.slots %}
                    {% with remaining=slot.remaining available=slot.available %}
                      <td class="p-1">
                        <button
                          type="button"
                          class="btn btn-outline-light btn-sm w-100"
                          data-slot-button="1"
                          data-slot="{{ slot.key }}"
                          data-date="{{ d_iso }}"
                          data-timeslot-pk="{{ d_iso }}"
                          data-left="{{ slot.remaining }}"
                        >

                        {{ slot.remaining }} / {{ slot.available }}

                        </button>
                      </td>
                    {% endwith %}
                  {% endfor %}
                </tr>
              {% endwith %}

            {% empty %}
              <tr>
                <td colspan="6" class="text-center text-muted py-4">
                  No availability data found.
                </td>
              </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>
    </div>
  </div>

  <div class="card bg-dark text-light shadow-sm">
    <div class="card-header">
      <strong>Caller details & confirmation</strong>
    </div>

    <div class="card-body">
      <form id="phoneReservationForm" method="post" action="{% url 'create_phone_reservation' %}">
        {% csrf_token %}

        {# These MUST be set by the grid click #}
        {{ form.reservation_date }}
        {{ form.time_slot }}
        {{ form.timeslot_availability }}

        <div id="slotAlert" class="alert alert-danger d-none mb-3">
          Please click a date/time cell in the availability grid before confirming.
        </div>

        <div class="alert alert-secondary small mb-3">
          <div>
            <strong>Selected slot:</strong>
            <span id="selectedSlotDisplay">None</span>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">First name</label>
            {{ form.first_name }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Last name</label>
            {{ form.last_name }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Email</label>
            {{ form.email }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Phone</label>
            {{ form.phone }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Mobile</label>
            {{ form.mobile }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Tables needed</label>
            {{ form.number_of_tables_required_by_patron }}
          </div>
        </div>

        <div class="d-flex justify-content-end mt-4">
          <button type="submit" class="btn btn-danger">
            Confirm Phone Reservation
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const dateInput     = document.getElementById("id_reservation_date");
  const slotInput     = document.getElementById("id_time_slot");
  const timeslotInput = document.getElementById("id_timeslot_availability");
  const form          = document.getElementById("phoneReservationForm");
  const alertBox      = document.getElementById("slotAlert");
  const selectedEl    = document.getElementById("selectedSlotDisplay");

  const slotButtons = Array.from(document.querySelectorAll("[data-slot-button]"));

  function clearHighlights() {
    slotButtons.forEach(b => {
      b.classList.remove("btn-light", "text-dark");
      if (!b.disabled) {
        b.classList.add("btn-outline-light");
      }
    });
  }

  function setSelected(dateISO, slotKey, timeslotPK) {
    if (dateInput) dateInput.value = dateISO || "";
    if (slotInput) slotInput.value = slotKey || "";

    // IMPORTANT:
    // TimeSlotAvailability PK is calendar_date (DateField primary_key=True),
    // so the form field must receive YYYY-MM-DD, NOT a human date string.
    if (timeslotInput) timeslotInput.value = timeslotPK || "";

    if (selectedEl) {
      selectedEl.textContent = (dateISO && slotKey) ? `${dateISO} @ ${slotKey}` : "None";
    }

    if (alertBox) alertBox.classList.add("d-none");
  }

  slotButtons.forEach((btn) => {
    btn.addEventListener("click", function () {
      if (this.disabled) return;

      const dateISO   = this.getAttribute("data-date") || "";
      const slotKey   = this.getAttribute("data-slot") || "";
      const timeslotPK = this.getAttribute("data-timeslot-pk") || dateISO;

      setSelected(dateISO, slotKey, timeslotPK);

      clearHighlights();
      this.classList.remove("btn-outline-light");
      this.classList.add("btn-light", "text-dark");
    });
  });

  form.addEventListener("submit", function (e) {
    const dateVal = dateInput ? dateInput.value : "";
    const slotVal = slotInput ? slotInput.value : "";
    const tsVal   = timeslotInput ? timeslotInput.value : "";

    if (!dateVal || !slotVal || !tsVal) {
      e.preventDefault();
      if (alertBox) {
        alertBox.classList.remove("d-none");
        alertBox.scrollIntoView({ behavior: "smooth", block: "center" });
      }
    }
  });

  // Auto-select first available slot button
  const firstAvailable = document.querySelector("[data-slot-button]:not([disabled])");
  if (firstAvailable) firstAvailable.click();
});
</script>
{% endblock %}
