{% extends "base.html" %}
{% load reservation_extras %}
{% load static %}

{% block content %}
<div class="container mt-4">

  <h2 class="mb-3">Create Phone Reservation</h2>

  <p class="text-muted">
    Step 1: Click a date + time slot in the grid below.<br>
    Step 2: Fill in customer details, choose duration / options, then confirm.
  </p>

  <style>
    /* --- Grid readability + contrast (protect against theme/background CSS) --- */
    .availability-grid table { width: 100%; }
    .availability-grid th, .availability-grid td { vertical-align: middle; }
    .availability-grid .slot-btn {
      font-weight: 700;
      font-size: 0.85rem;
      line-height: 1.2;
      padding: 0.35rem 0.25rem;
      border-radius: 0.35rem;
      border: 1px solid rgba(0,0,0,.15);
      white-space: nowrap;
    }
    .availability-grid .slot-btn.enabled {
      background: #198754; /* bootstrap success */
      color: #fff;
    }
    .availability-grid .slot-btn.enabled:hover {
      filter: brightness(0.95);
    }
    .availability-grid .slot-btn.disabled {
      background: #6c757d; /* bootstrap secondary */
      color: #fff;
      opacity: 0.75;
      border-color: rgba(0,0,0,.10);
    }
    .availability-grid .slot-btn.is-selected {
      outline: 3px solid rgba(13,110,253,.35); /* bootstrap primary-ish */
      box-shadow: 0 0 0 3px rgba(13,110,253,.15);
    }
    .availability-grid .free-count {
      display: inline-block;
      min-width: 3.5ch;
    }
  </style>

  <form method="post" novalidate id="phoneReservationForm">
    {% csrf_token %}

    {# Hidden fields controlled by the grid click #}
    {{ form.reservation_date }}
    {{ form.time_slot }}
    {{ form.timeslot_availability }}

    <div class="row">
      <div class="col-lg-8">

        <div class="card mb-3">
          <div class="card-header">
            Availability Grid (next 30 days)
          </div>
          <div class="card-body availability-grid">

            <div class="mb-2">
              <strong>Selected slot:</strong>
              <span id="selected-slot-display" class="text-primary">None</span>
            </div>

            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>Date</th>
                    {% for slot_key, slot_label in slot_labels.items %}
                      <th class="text-center">{{ slot_label }}</th>
                    {% endfor %}
                  </tr>
                </thead>

                <tbody>
                  {% for day_data in next_30_days %}
                    <tr>
                      <td>
                        {{ day_data.date|date:"D M j, Y" }}
                      </td>

                      {% for slot_key, slot_label in slot_labels.items %}
                        {% with info=day_data.slots|get_item:slot_key %}
                          <td class="text-center p-1">
                            {% if info and info.enabled %}
                              <button
                                type="button"
                                class="slot-btn enabled w-100"
                                data-date="{{ day_data.date|date:'Y-m-d' }}"
                                data-slot="{{ slot_key }}"
                                data-slot-label="{{ slot_label }}"
                                data-timeslot-pk="{{ day_data.timeslot_pk }}"
                              >
                                <span class="free-count">{{ info.available }}</span> free
                              </button>
                            {% else %}
                              <button
                                type="button"
                                class="slot-btn disabled w-100"
                                disabled
                                aria-disabled="true"
                              >
                                {% if info %}
                                  <span class="free-count">{{ info.available }}</span> free
                                {% else %}
                                  â€”
                                {% endif %}
                              </button>
                            {% endif %}
                          </td>
                        {% endwith %}
                      {% endfor %}

                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="small text-muted mt-2">
              Green buttons are selectable. Disabled buttons are full/unavailable.
            </div>

          </div>
        </div>

      </div>

      <div class="col-lg-4">

        <div class="card mb-3">
          <div class="card-header">Customer Details</div>
          <div class="card-body">

            <div class="mb-2">
              <label class="form-label">First Name</label>
              {{ form.first_name }}
              {% if form.first_name.errors %}<div class="text-danger small">{{ form.first_name.errors }}</div>{% endif %}
            </div>

            <div class="mb-2">
              <label class="form-label">Last Name</label>
              {{ form.last_name }}
              {% if form.last_name.errors %}<div class="text-danger small">{{ form.last_name.errors }}</div>{% endif %}
            </div>

            <div class="mb-2">
              <label class="form-label">Email</label>
              {{ form.email }}
              {% if form.email.errors %}<div class="text-danger small">{{ form.email.errors }}</div>{% endif %}
            </div>

            <div class="mb-2">
              <label class="form-label">Phone</label>
              {{ form.phone }}
              {% if form.phone.errors %}<div class="text-danger small">{{ form.phone.errors }}</div>{% endif %}
            </div>

            <div class="mb-3">
              <label class="form-label">Mobile</label>
              {{ form.mobile }}
              {% if form.mobile.errors %}<div class="text-danger small">{{ form.mobile.errors }}</div>{% endif %}
            </div>

          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header">Reservation Options</div>
          <div class="card-body">

            <div class="mb-2">
              <label class="form-label">Tables needed</label>
              {{ form.number_of_tables_required_by_patron }}
              {% if form.number_of_tables_required_by_patron.errors %}<div class="text-danger small">{{ form.number_of_tables_required_by_patron.errors }}</div>{% endif %}
            </div>

            <div class="mb-2">
              <label class="form-label">Duration (hours)</label>
              {{ form.duration_hours }}
              {% if form.duration_hours.errors %}<div class="text-danger small">{{ form.duration_hours.errors }}</div>{% endif %}
              <div class="small text-muted">Books consecutive hours starting from the selected slot.</div>
            </div>

            <div class="form-check mb-3">
              {{ form.book_until_close }}
              <label class="form-check-label" for="{{ form.book_until_close.id_for_label }}">
                Book from selected start until kitchen close
              </label>
              <div class="small text-muted">Overrides duration and books all remaining slots that day.</div>
            </div>

            <hr>

            <div class="mb-2">
              <label class="form-label">Conference series (days)</label>
              {{ form.series_days }}
              {% if form.series_days.errors %}<div class="text-danger small">{{ form.series_days.errors }}</div>{% endif %}
              <div class="small text-muted">
                If &gt; 1, books the same slot (and duration/until-close rule) for consecutive days.
              </div>
            </div>

          </div>
        </div>

        <button type="submit" class="btn btn-primary w-100">
          Confirm Phone Reservation
        </button>

      </div>
    </div>

  </form>

</div>

<script>
(function () {
  const form = document.getElementById("phoneReservationForm");

  // Robust lookup: ID first, then name
  function byIdOrName(id, name) {
    return document.getElementById(id) || document.querySelector(`[name="${name}"]`);
  }

  const reservationDateInput = byIdOrName("id_reservation_date", "reservation_date");
  const timeSlotInput = byIdOrName("id_time_slot", "time_slot");
  const timeslotAvailabilityInput = byIdOrName("id_timeslot_availability", "timeslot_availability");

  const display = document.getElementById("selected-slot-display");

  let lastSelectedBtn = null;

  document.querySelectorAll(".slot-btn.enabled").forEach(btn => {
    btn.addEventListener("click", () => {
      const date = btn.dataset.date || "";
      const slot = btn.dataset.slot || "";
      const slotLabel = btn.dataset.slotLabel || slot;
      const tsPk = btn.dataset.timeslotPk || "";

      if (!reservationDateInput || !timeSlotInput) return;

      reservationDateInput.value = date;
      timeSlotInput.value = slot;
      if (timeslotAvailabilityInput && tsPk) {
        timeslotAvailabilityInput.value = tsPk;
      }

      // Visual highlight
      if (lastSelectedBtn) lastSelectedBtn.classList.remove("is-selected");
      btn.classList.add("is-selected");
      lastSelectedBtn = btn;

      display.textContent = `${date} / ${slotLabel}`;
    });
  });

  form.addEventListener("submit", (e) => {
    const hasDate = reservationDateInput && reservationDateInput.value;
    const hasSlot = timeSlotInput && timeSlotInput.value;

    if (!hasDate || !hasSlot) {
      e.preventDefault();
      alert("Please click a date/time cell in the availability grid before confirming.");
    }
  });
})();
</script>

{% endblock %}
