{% extends "base.html" %}
{% load static %}
{% load slot_filters %}

{% block content %}
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Phone Reservation</h2>
    <a href="{% url 'staff_dashboard' %}" class="btn btn-outline-light">Back to Dashboard</a>
  </div>

  <p class="text-muted">
    Click an availability cell to select a date/time slot, then complete caller details and confirm.
  </p>

  <div class="card bg-dark text-light shadow-sm mb-4">
    <div class="card-header">
      <strong>Next 30 days availability</strong>
    </div>

    <div class="card-body p-2">
      <div class="table-responsive">
        <table class="table table-dark table-bordered align-middle mb-0">
          <thead>
            <tr>
              <th style="min-width: 180px;">Date</th>
              {% for slot in slot_labels.items %}
                <th class="text-center">{{ slot.1 }}</th>
              {% endfor %}
            </tr>
          </thead>

          {# âœ… FIXED TBODY: correct variables + correct date/id mapping #}
            <tbody>
                {% for day_data in next_30_days %}
                    {# day_data is a dict: has "date", "timeslot", "slots" #}

                    {% if day_data.date %}
                    {% with d=day_data.date d_iso=day_data.date|date:"Y-m-d" %}
                        <tr>
                        <td class="align-middle">
                            {{ d|date:"D, M j, Y" }}
                        </td>

                        {% for slot in day_data.slots %}
                            {% with remaining=slot.remaining available=slot.available %}
                            <td class="p-1">
                                <button
                                type="button"
                                class="btn btn-sm w-100 {% if remaining <= 0 %}btn-secondary disabled{% else %}btn-light text-dark{% endif %}"
                                data-slot-button="1"
                                data-date="{{ d_iso }}"
                                data-slot="{{ slot.key }}"
                                data-timeslot-id="{{ day_data.timeslot.id }}"
                                {% if remaining <= 0 %}disabled{% endif %}
                                >
                                {% if remaining <= 0 %}
                                    FULL
                                {% else %}
                                    {{ remaining }} / {{ available }}
                                {% endif %}
                                </button>
                            </td>
                            {% endwith %}
                        {% endfor %}
                        </tr>
                    {% endwith %}

                    {% else %}
                    {# Fallback: if for some reason "date" is missing, use the model #}
                    {% with d=day_data.timeslot.calendar_date d_iso=day_data.timeslot.calendar_date|date:"Y-m-d" %}
                        <tr>
                        <td class="align-middle">
                            {{ d|date:"D, M j, Y" }}
                        </td>

                        {% for slot in day_data.slots %}
                            {% with remaining=slot.remaining available=slot.available %}
                            <td class="p-1">
                                <button
                                    type="button"
                                    class="btn {% if remaining <= 0 %}btn-secondary disabled{% else %}btn-outline-light{% endif %} btn-sm w-100"
                                    data-slot-button="1"
                                    data-date="{{ day_data.date|date:'Y-m-d' }}"
                                    data-slot="{{ slot.key }}"
                                    data-timeslot-id="{{ day_data.timeslot.id }}"
                                    {% if remaining <= 0 %}disabled{% endif %}
                                >
                                {% if remaining <= 0 %}
                                    FULL
                                {% else %}
                                    {{ remaining }} / {{ available }}
                                {% endif %}
                                </button>
                            </td>
                            {% endwith %}
                        {% endfor %}
                        </tr>
                    {% endwith %}
                    {% endif %}

                {% empty %}
                    <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                        No availability data found.
                    </td>
                    </tr>
                {% endfor %}
                </tbody>



        </table>
      </div>
    </div>
  </div>

  <div class="card bg-dark text-light shadow-sm">
    <div class="card-header">
      <strong>Caller details & confirmation</strong>
    </div>

    <div class="card-body">
      <form id="phoneReservationForm" method="post" action="{% url 'create_phone_reservation' %}">
        {% csrf_token %}

        {# These MUST be set by the grid click #}
        {{ form.reservation_date }}
        {{ form.time_slot }}
        {{ form.timeslot_availability }}

        <div class="alert alert-secondary small mb-3">
          <div><strong>Selected slot:</strong> <span id="selectedSlotDisplay">None</span></div>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">First name</label>
            {{ form.first_name }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Last name</label>
            {{ form.last_name }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Email</label>
            {{ form.email }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Phone</label>
            {{ form.phone }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Mobile</label>
            {{ form.mobile }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Tables needed</label>
            {{ form.number_of_tables_required_by_patron }}
          </div>
        </div>

        <div class="d-flex justify-content-end mt-4">
          <button type="submit" class="btn btn-danger">
            Confirm Phone Reservation
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const dateInput = document.getElementById("id_reservation_date");
    const slotInput = document.getElementById("id_time_slot");
    const timeslotInput = document.getElementById("id_timeslot_availability");
    const form = document.getElementById("phoneReservationForm");
    const alert = document.getElementById("slotAlert");

    let slotSelected = false;

    const slotButtons = document.querySelectorAll("[data-slot-button]");

    slotButtons.forEach(function (btn) {
        btn.addEventListener("click", function () {
            const date = this.getAttribute("data-date");
            const slot = this.getAttribute("data-slot");
            const timeslotId = this.getAttribute("data-timeslot-id");  // <-- ID

            dateInput.value = date || "";
            slotInput.value = slot || "";
            timeslotInput.value = timeslotId || "";  // <-- Set the ID

            slotSelected = true;

            // Highlight
            slotButtons.forEach(b => b.classList.remove("btn-light", "text-dark"));
            slotButtons.forEach(b => b.classList.add("btn-outline-light"));

            if (!this.disabled) {
                this.classList.remove("btn-outline-light");
                this.classList.add("btn-light", "text-dark");
            }

            if (alert) alert.classList.add("d-none");
        });
    });

    form.addEventListener("submit", function (e) {
        if (!slotSelected || !timeslotInput.value) {
            e.preventDefault();
            if (alert) {
                alert.classList.remove("d-none");
                alert.scrollIntoView({ behavior: "smooth" });
            }
        }
    });

    // Auto-select first available
    const first = document.querySelector("[data-slot-button]:not([disabled])");
    if (first) first.click();
});
</script>
{% endblock %}
